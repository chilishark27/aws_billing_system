{% extends "base.html" %}

{% block title %}æ‰€æœ‰èµ„æºæ‰«æ{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">ğŸ” AWSæ‰€æœ‰èµ„æºæ‰«æ</h1>
    <p class="page-subtitle">å¼‚æ­¥æ‰«ææ‰€æœ‰AWSèµ„æºå¹¶è®¡ç®—æ¯æ—¥æˆæœ¬</p>
</div>

<div class="content-card">
    <button id="scanBtn" class="refresh-btn" onclick="startScan()">
        ğŸš€ å¼€å§‹æ‰«ææ‰€æœ‰èµ„æº
    </button>
                    
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <span>æ­£åœ¨æ‰«æèµ„æº...</span>
    </div>
    
    <div id="status"></div>
    
    <div id="progress" style="display:none; margin: 20px 0;">
        <div style="background: #e9ecef; height: 20px; border-radius: 10px; overflow: hidden;">
            <div id="progressBar" style="background: linear-gradient(135deg, #667eea, #764ba2); height: 100%; width: 0%; transition: width 0.3s;"></div>
        </div>
        <div id="progressText" style="text-align: center; margin-top: 10px; font-weight: 600;">0%</div>
    </div>
    
    <div id="summary" class="stats-grid" style="display:none; margin: 30px 0;">
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-server"></i></div>
            <div class="stat-value" id="totalResources">0</div>
            <div class="stat-label">æ€»èµ„æºæ•°</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-dollar-sign"></i></div>
            <div class="stat-value" id="dailyCost">$0.00</div>
            <div class="stat-label">é¢„ä¼°æ¯æ—¥æˆæœ¬</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-download"></i></div>
            <div class="stat-value" id="exportFile" style="font-size: 1.2em;">-</div>
            <div class="stat-label">å¯¼å‡ºæ–‡ä»¶</div>
        </div>
    </div>
    
    <div id="results"></div>
</div>

<script>
function startScan() {
    const btn = document.getElementById('scanBtn');
    showLoading(true);
    document.getElementById('progress').style.display = 'block';
    document.getElementById('summary').style.display = 'none';
    document.getElementById('results').innerHTML = '';
    
    fetch('/api/scan-all-resources')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                checkScanStatus();
            } else {
                showLoading(false);
                document.getElementById('status').innerHTML = `<div style="color: var(--accent-color); padding: 15px; text-align: center;">âŒ å¯åŠ¨å¤±è´¥: ${data.error}</div>`;
            }
        });
}

function checkScanStatus() {
    fetch('/api/scan-status')
        .then(response => response.json())
        .then(data => {
            updateProgress(data.progress);
            
            if (data.running) {
                setTimeout(checkScanStatus, 1000);
            } else if (data.results) {
                showLoading(false);
                const results = data.results;
                document.getElementById('status').innerHTML = 
                    `<div style="background: rgba(39, 174, 96, 0.1); color: #27ae60; padding: 15px; border-radius: 10px; margin: 20px 0; text-align: center; font-weight: 600;">âœ… æ‰«æå®Œæˆï¼</div>`;
                
                document.getElementById('totalResources').textContent = results.total_resources;
                document.getElementById('dailyCost').textContent = `$${results.total_daily_cost.toFixed(2)}`;
                document.getElementById('exportFile').textContent = results.export_file.split('/').pop();
                document.getElementById('summary').style.display = 'grid';
                
                displayResults(results.resources);
            } else if (data.error) {
                showLoading(false);
                document.getElementById('status').innerHTML = 
                    `<div style="color: var(--accent-color); padding: 15px; text-align: center;">âŒ æ‰«æå¤±è´¥: ${data.error}</div>`;
            }
        });
}

function updateProgress(progress) {
    document.getElementById('progressBar').style.width = progress + '%';
    document.getElementById('progressText').textContent = progress + '%';
}

function displayResults(resources) {
    const results = document.getElementById('results');
    let html = '';
    
    for (const [region, regionResources] of Object.entries(resources)) {
        if (Object.keys(regionResources).length === 0) continue;
        
        html += `<div class="content-card">
            <h3 style="color: var(--primary-color); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--secondary-color);">
                ğŸ“ ${region}
            </h3>`;
        
        for (const [service, items] of Object.entries(regionResources)) {
            if (items.length === 0) continue;
            
            html += `<h4 style="color: var(--secondary-color); margin: 20px 0 15px 0;">
                ${getServiceIcon(service)} ${service} 
                <span style="background: var(--secondary-color); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 10px;">${items.length}</span>
            </h4>`;
            
            html += `<div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>èµ„æºID</th>
                            <th>è¯¦æƒ…</th>
                            <th>æ¯æ—¥æˆæœ¬</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            items.forEach(item => {
                const dailyCost = item.daily_cost || 0;
                const costClass = getCostClass(dailyCost);
                const costDisplay = dailyCost > 0 ? `$${dailyCost.toFixed(2)}` : 'å…è´¹';
                
                html += `<tr>
                    <td><span class="resource-id">${item.resource_id}</span></td>
                    <td>${formatResourceDetails(item)}</td>
                    <td><span class="${costClass}">${costDisplay}</span></td>
                </tr>`;
            });
            
            html += `</tbody></table></div>`;
        }
        
        html += `</div>`;
    }
    
    results.innerHTML = html || '<div class="empty-state"><i class="fas fa-search"></i><p>æœªæ‰¾åˆ°ä»»ä½•èµ„æº</p></div>';
}

function getServiceIcon(service) {
    const icons = {
        'EC2': 'ğŸ’»', 'RDS': 'ğŸ—„ï¸', 'Lambda': 'âš¡', 'S3': 'ğŸª£', 'EBS': 'ğŸ’¾',
        'VPC': 'ğŸŒ', 'Subnet': 'ğŸ”—', 'NAT_Gateway': 'ğŸšª', 'ECS_Cluster': 'ğŸ³',
        'ECS_Service': 'âš™ï¸', 'EKS': 'â˜¸ï¸', 'DynamoDB': 'ğŸ“Š', 'SNS': 'ğŸ“¢',
        'SQS': 'ğŸ“¬', 'CloudWatch_Alarm': 'âš ï¸', 'CloudWatch_Logs': 'ğŸ“',
        'LoadBalancer': 'âš–ï¸', 'IAM_User': 'ğŸ‘¤', 'IAM_Role': 'ğŸ­', 'IAM_Policy': 'ğŸ“‹',
        'CloudFront': 'ğŸŒ', 'Route53': 'ğŸŒ', 'AMI': 'ğŸ’¿', 'Snapshot': 'ğŸ“¸'
    };
    return icons[service] || 'ğŸ”§';
}

function formatResourceDetails(item) {
    let details = [];
    for (const [key, value] of Object.entries(item)) {
        if (key !== 'resource_id' && key !== 'service' && key !== 'region' && 
            key !== 'hourly_cost' && key !== 'daily_cost' && value) {
            details.push(`${key}: ${value}`);
        }
    }
    return details.join(' | ') || '-';
}
</script>
{% endblock %}